<%- include('../includes/head.ejs') %>

<!-- Tempusdominus Bootstrap 4 -->
<link rel="stylesheet" href="/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">

<!-- DataTables -->
<link rel="stylesheet" href="/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
<link rel="stylesheet" href="/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
</head>

<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <!-- Navbar -->
    <%- include('../includes/navbar.ejs') %>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <%- include('../includes/sidebar.ejs') %>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <%- include('../includes/content-header.ejs') %>

      <!-- Main content -->
      <section class="content">
        <div class="container-fluid">

          <div class="row">
            <div class="col-md-12">
              <!-- Error Message -->
              <%- include('../includes/flash-message.ejs') %>

              <!-- general form elements -->
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title text-capitalize">Treatments</h3>
                </div>
                <!-- /.card-header -->
                <div class="card-body">
                  <table id="tbl_Treatments" class="table table-bordered table-striped">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Treatment</th>
                        <th>Price (S$)</th>
                        <th>Treated Tooth(s)</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% for(let i = 0; i < treatmentData.length; i++) { %>
                      <tr>
                        <td><%= i + 1 %></td>
                        <td><%= treatmentData[i].treatmentName %></td>
                        <td><%= treatmentData[i].treatmentPrice %></td>
                        <td><%= treatmentData[i].treatmentTeeth === '1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32' ? 'ALL' : treatmentData[i].treatmentTeeth %></td>
                        <td><%= treatmentData[i].treatmentStart %></td>
                        <td><%= treatmentData[i].treatmentEnd !== 'Invalid date' ? treatmentData[i].treatmentEnd : 'In progress' %></td>
                        <td class="d-flex">
                          <% if (treatmentData[i].treatmentEnd === 'Invalid date') { %>
                          <button type="button" class="btn btn-primary mr-2" title="Update" data-toggle="modal" data-target="#treatmentModal" data-id="<%= treatmentData[i].treatmentId %>" data-action="Update" data-treatment="<%= treatmentData[i].treatmentName + ' | S$ ' + treatmentData[i].treatmentPrice %>" data-teeth="<%= treatmentData[i].treatmentTeeth %>">
                            <i class="fas fa-edit"></i>
                          </button>
                          <form action="#" method="post" onsubmit="return confirm('Do you want to mark `<%= treatmentData[i].treatmentName %>` as done? This action is irreversible.');">
                            <input type="hidden" name="treatmentId" value="<%= treatmentData[i].treatmentId %>">
                            <button type="submit" class="btn btn-success mr-2" title="Mark as Done"><i class="fas fa-check"></i></button>
                          </form>
                          <form action="/dentist/appointment/in-session/treatment/delete" method="post" onsubmit="return confirm('Do you really want to delete record #<%= i + 1 %>? This action is irreversible.');">
                            <input type="hidden" name="treatmentId" value="<%= treatmentData[i].treatmentId %>">
                            <button type="submit" class="btn btn-danger" title="Delete"><i class="fas fa-trash"></i></button>
                          </form>
                          <% } %>
                        </td>
                      </tr>
                      <% } %>
                    </tbody>
                    <tfoot>
                      <tr>
                        <th>#</th>
                        <th>Treatment</th>
                        <th>Price (S$)</th>
                        <th>Treated Tooth(s)</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Actions</th>
                      </tr>
                    </tfoot>
                  </table>
                </div>
                <!-- /.card-body -->

                <div class="card-footer text-right">
                  <!-- Button trigger modal -->
                  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#treatmentModal" data-action="Add">Add Record</button>
                </div>
              </div>
              <!-- /.card -->
            </div>
          </div>

          <!-- Modal -->
          <div class="modal fade" id="treatmentModal" tabindex="-1" aria-labelledby="treatmentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <form id="form_TreatmentRecord" action="/dentist/appointment/in-session/treatment/add" method="post" onsubmit="return ($('input.form-check-input:checkbox:checked').length > 0)">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="treatmentModalLabel"><span id="lblModalAction">Add</span> Treatment Record</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <div class="row">
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="ddl_Treatment">Treatment<span style="color:red;">*</span></label>
                          <select id="ddl_Treatment" name="ctId" class="custom-select" required>
                            <option selected="selected" value="" disabled>Select treatment...</option>
                            <% for (let i = 0; i < clinicTreatmentData.length; i++) { %>
                            <option value="<%= clinicTreatmentData[i].ctId %>"><%= clinicTreatmentData[i].ctName %> | <%= 'S$ ' + clinicTreatmentData[i].ctPrice %></option>
                            <% } %>
                          </select>
                          <input class="form-control-plaintext" type="text" id="tb_TreatmentName" style="display: none;">
                        </div>
                      </div>
                      <div class="col-md-12">
                        <label>Treated Tooth(s)<span style="color:red;">*</span></label>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_1" value="1">
                            <label class="form-check-label" for="cb_1">01</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_2" value="2">
                            <label class="form-check-label" for="cb_2">02</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_3" value="3">
                            <label class="form-check-label" for="cb_3">03</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_4" value="4">
                            <label class="form-check-label" for="cb_4">04</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_5" value="5">
                            <label class="form-check-label" for="cb_5">05</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_6" value="6">
                            <label class="form-check-label" for="cb_6">06</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_7" value="7">
                            <label class="form-check-label" for="cb_7">07</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_8" value="8">
                            <label class="form-check-label" for="cb_8">08</label>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_9" value="9">
                            <label class="form-check-label" for="cb_9">09</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_10" value="10">
                            <label class="form-check-label" for="cb_10">10</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_11" value="11">
                            <label class="form-check-label" for="cb_11">11</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_12" value="12">
                            <label class="form-check-label" for="cb_12">12</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_13" value="13">
                            <label class="form-check-label" for="cb_13">13</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_14" value="14">
                            <label class="form-check-label" for="cb_14">14</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_15" value="15">
                            <label class="form-check-label" for="cb_15">15</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_16" value="16">
                            <label class="form-check-label" for="cb_16">16</label>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_17" value="17">
                            <label class="form-check-label" for="cb_17">17</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_18" value="18">
                            <label class="form-check-label" for="cb_18">18</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_19" value="19">
                            <label class="form-check-label" for="cb_19">19</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_20" value="20">
                            <label class="form-check-label" for="cb_20">20</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_21" value="21">
                            <label class="form-check-label" for="cb_21">21</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_22" value="22">
                            <label class="form-check-label" for="cb_22">22</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_23" value="23">
                            <label class="form-check-label" for="cb_23">23</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_24" value="24">
                            <label class="form-check-label" for="cb_24">24</label>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_25" value="25">
                            <label class="form-check-label" for="cb_25">25</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_26" value="26">
                            <label class="form-check-label" for="cb_26">26</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_27" value="27">
                            <label class="form-check-label" for="cb_27">27</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_28" value="28">
                            <label class="form-check-label" for="cb_28">28</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_29" value="29">
                            <label class="form-check-label" for="cb_29">29</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_30" value="30">
                            <label class="form-check-label" for="cb_30">30</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_31" value="31">
                            <label class="form-check-label" for="cb_31">31</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" name="treatmentTeeth" type="checkbox" id="cb_32" value="32">
                            <label class="form-check-label" for="cb_32">32</label>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-12">
                        <div class="form-group">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="cb_All" value="All">
                            <label class="form-check-label" for="cb_All">ALL</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <input type="hidden" name="apptId" value="<%= appointmentData.apptId %>">
                    <input id="tb_TreatmentId" type="hidden" name="treatmentId" value="">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button id="btnSaveTreatment" type="submit" class="btn btn-primary">Save</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
          <!-- /Modal -->

          <hr>

          <div class="row mt-4 mb-4">
            <div class="col-md-12">
              <button id="btnAppointmentSummary" class="btn btn-outline-primary" type="button" data-toggle="collapse" data-target="#divAppointmentSummary" aria-expanded="false" aria-controls="divAppointmentSummary">
                <i class="nav-icon fas fa-plus"></i>&nbsp;&nbsp;
                Appointment Summary
              </button>
            </div>
          </div>

          <div id="divAppointmentSummary" class="collapse">
            <div class="row">
              <div class="col-md-12">
                <!-- general form elements -->
                <div class="card card-primary">
                  <div class="card-header">
                    <h3 class="card-title">Appointment Summary</h3>
                  </div>
                  <!-- /.card-header -->
                  <!-- form start -->
                  <form>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="tb_firstName">First Name:</label>
                            <input type="text" class="form-control-plaintext" id="tb_firstName" name="firstName" tabindex="1" value="<%= appointmentData.firstName %>" disabled>
                          </div>
                          <div class="form-group">
                            <label for="tb_NRIC">Patient's NRIC:</label>
                            <input type="text" class="form-control-plaintext" id="tb_NRIC" name="nric" tabindex="3" value="<%= appointmentData.nric %>" disabled>
                          </div>
                          <div class="form-group">
                            <label for="tb_Dentist">Dentist:</label>
                            <input type="text" class="form-control-plaintext" id="tb_Dentist" name="name" tabindex="5" value="Dr. <%= dentistData.firstName + ' ' + dentistData.lastName %>" disabled>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="tb_lastName">Last Name (Surname):</label>
                            <input type="text" class="form-control-plaintext" id="tb_lastName" name="lastName" tabindex="2" value="<%= appointmentData.lastName %>" disabled>
                          </div>
                          <div class="form-group">
                            <label for="tb_ClinicName">Clinic Name:</label>
                            <input type="text" class="form-control-plaintext" id="tb_ClinicName" name="clinicName" tabindex="4" value="<%= dentistData.clinicName %>" disabled>
                          </div>
                          <div class="form-group">
                            <label for="tb_ApptDateTime">Appointment Date & Time:</label>
                            <input type="text" class="form-control-plaintext" id="tb_ApptDateTime" name="startDateTime" tabindex="6" value="<%= appointmentData.startDateTime %>" disabled>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- /.card-body -->
                  </form>
                </div>
                <!-- /.card -->
              </div>
            </div>
            <!-- /.row -->
          </div>

          <!-- Patient Details Card -->
          <%- include('../includes/patient-card.ejs') %>
        </div><!-- /.container-fluid -->
      </section>
      <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <!-- End -->
    <%- include('../includes/footer.ejs') %>
  </div>
  <!-- ./wrapper -->

  <!-- REQUIRED SCRIPTS -->
  <%- include('../includes/end-scripts.ejs') %>

  <!-- DataTables  & Plugins -->
  <script src="/plugins/datatables/jquery.dataTables.min.js"></script>
  <script src="/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
  <script src="/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
  <script src="/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
  <script src="/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
  <script src="/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
  <script src="/plugins/jszip/jszip.min.js"></script>
  <script src="/plugins/pdfmake/pdfmake.min.js"></script>
  <script src="/plugins/pdfmake/vfs_fonts.js"></script>
  <script src="/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
  <script src="/plugins/datatables-buttons/js/buttons.print.min.js"></script>
  <script src="/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>

  <!-- Tempusdominus Bootstrap 4 -->
  <script src="/plugins/moment/moment.min.js"></script>
  <script src="/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="/dist/js/demo.js"></script>

  <script>
    $(function() {
      $("#tbl_Treatments").DataTable({
        "responsive": true,
        "lengthChange": false,
        "autoWidth": false,
        "buttons": [{
            extend: 'copy',
            exportOptions: {
              columns: 'th:not(:last-child)'
            }
          },
          {
            extend: 'csv',
            exportOptions: {
              columns: 'th:not(:last-child)'
            }
          },
          {
            extend: 'excel',
            exportOptions: {
              columns: 'th:not(:last-child)'
            }
          },
          {
            extend: 'pdf',
            exportOptions: {
              columns: 'th:not(:last-child)'
            }
          },
          {
            extend: 'print',
            exportOptions: {
              columns: 'th:not(:last-child)'
            }
          },
          "colvis"
        ]
      }).buttons().container().appendTo('#tbl_Treatments_wrapper .col-md-6:eq(0)');
    });

    // Expand & Collapse Appointment Summary
    $('#btnAppointmentSummary').click(function() {
      $(this).toggleClass('btn-outline-primary').toggleClass('btn-primary');
      $(this).find('i').toggleClass('fa-plus').toggleClass('fa-minus');
    });

    // Set modal info
    $('button[data-target="#treatmentModal"]').click(function() {
      $('#form_TreatmentRecord')[0].reset();

      const action = $(this).data('action');
      const treatmentId = $(this).data('id') ? $(this).data('id') : '';
      const treatmentName = $(this).data('treatment') ? $(this).data('treatment') : '';
      const treatmentTeeth = $(this).data('teeth') ? $(this).data('teeth').split(',') : '';

      if (action === 'Add')
        $('#form_TreatmentRecord').attr('action', '/dentist/appointment/in-session/treatment/add');
      if (action === 'Update')
        $('#form_TreatmentRecord').attr('action', '/dentist/appointment/in-session/treatment/edit');

      $('#lblModalAction').text(action);
      $('#tb_TreatmentId').val(treatmentId);
      $('#ddl_Treatment option').filter(function() {
        return $(this).text() === treatmentName;
      }).prop('selected', true);

      let i = 0;
      for (i = 0; i < treatmentTeeth.length; i++) {
        $('#cb_' + treatmentTeeth[i]).prop('checked', true);
      }

      if (i === 32) $('#cb_All').prop('checked', true);
    });

    // Toggle all tooth checkboxes
    $('#cb_All').change(function() {
      if (this.checked) {
        for (let i = 1; i <= 32; i++) {
          $('#cb_' + i).prop('checked', true);
        }
      } else {
        for (let i = 1; i <= 32; i++) {
          $('#cb_' + i).prop('checked', false);
        }
      }
    });

    // Toggle `all` checkbox off when other checkboxes changes
    $('input.form-check-input:checkbox').change(function() {
      if (this.id !== 'cb_All')
        $('#cb_All').prop('checked', false);
    })

    // Custom Validation for "Add Treatment" form
    $('#btnSaveTreatment').click(function() {
      $('#ddl_Treatment')[0].setCustomValidity($('#ddl_Treatment').val() === null ? 'Please select a treatment in this list.' : '');
      $('#cb_1')[0].setCustomValidity($('input.form-check-input:checkbox:checked').length === 0 ? 'Please select an item in this group.' : '');
    })
  </script>
</body>

</html>